<!DOCTYPE html>
<html lang="ru">
<head>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Arrows Pro Ultra</title>
    <style>
        :root { --c-blue: #003366; --c-bg: #f4f6f9; --c-gray: #e0e0e0; --c-red: #ff4d4d; --c-green: #2ecc71; --c-gold: #FFD700; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; margin: 0; padding: 0; }
        body { background: var(--c-bg); font-family: -apple-system, sans-serif; overflow: hidden; height: 100vh; display: flex; justify-content: center; }
        #app { width: 100%; max-width: 500px; height: 100%; position: relative; display: flex; flex-direction: column; }
        
        .screen { position: absolute; inset: 0; display: none; flex-direction: column; background: var(--c-bg); z-index: 10; }
        .screen.active { display: flex; }

        .top-ui { padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; min-height: 70px; z-index: 100; }
        .top-left-group { display: flex; align-items: center; gap: 10px; }
        .lives-pill { background: white; padding: 8px 15px; border-radius: 25px; display: flex; align-items: center; gap: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); cursor: pointer; transition: transform 0.1s; }
        .lives-pill:active { transform: scale(0.95); }
        .coins-pill { background: white; padding: 8px 15px; border-radius: 25px; display: flex; align-items: center; gap: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
        .coins-icon { color: var(--c-gold); font-weight: bold; }

        .board-zone { flex: 1; display: flex; align-items: center; justify-content: center; padding: 20px; transition: 0.2s; }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }
        @keyframes redFlash {
            0% { box-shadow: 0 10px 30px rgba(0,0,0,0.1); border-color: transparent; }
            50% { box-shadow: 0 0 50px rgba(255, 77, 77, 0.6), inset 0 0 20px rgba(255, 77, 77, 0.2); border-color: var(--c-red); }
            100% { box-shadow: 0 10px 30px rgba(0,0,0,0.1); border-color: transparent; }
        }

        #board { background: white; border-radius: 25px; position: relative; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.1); border: 3px solid transparent; transition: background 0.3s; }
        .board-zone.error-shake #board { animation: shake 0.4s cubic-bezier(.36,.07,.19,.97) both, redFlash 0.5s ease-out; }

        .arrow-box { position: absolute; cursor: pointer; z-index: 2; transition: opacity 0.1s; }
        .arrow-svg { width: 100%; height: 100%; overflow: visible; display: block; }
        .p-line { fill: none; stroke: var(--c-blue); stroke-width: 5; stroke-linecap: round; stroke-linejoin: round; transition: stroke 0.2s; }
        .p-head { fill: var(--c-blue); transition: fill 0.2s; }
        .arrow-box.error-arr .p-line { stroke: var(--c-red); }
        .arrow-box.error-arr .p-head { fill: var(--c-red); }

        #scr-home { align-items: center; justify-content: center; }
        .logo { font-size: 4rem; font-weight: 900; color: var(--c-blue); margin-bottom: 5px; }
        .play-btn { width: 100px; height: 100px; background: var(--c-blue); border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 10px 20px rgba(0,51,102,0.25); cursor: pointer; margin-bottom: 20px; }
        .stats-row { display: flex; gap: 10px; margin-top: 10px; }
        
        .nav-bar { position: absolute; bottom: 0; width: 100%; height: 75px; background: white; display: flex; justify-content: space-around; align-items: center; z-index: 1000; box-shadow: 0 -2px 10px rgba(0,0,0,0.05); }
        .nav-icon { opacity: 0.3; color: var(--c-blue); cursor: pointer; }
        .nav-icon.active { opacity: 1; }

        .set-row { background: white; margin: 8px 20px; padding: 15px 20px; border-radius: 15px; display: flex; justify-content: space-between; align-items: center; }
        .toggle { width: 46px; height: 26px; background: var(--c-gray); border-radius: 13px; position: relative; transition: 0.3s; cursor: pointer; }
        .toggle.on { background: var(--c-blue); }
        .toggle::after { content: ''; position: absolute; top: 2px; left: 2px; width: 22px; height: 22px; background: white; border-radius: 50%; transition: 0.3s; }
        .toggle.on::after { left: 22px; }

        .l-btn { padding: 8px 15px; border: 1.5px solid var(--c-blue); border-radius: 8px; color: var(--c-blue); background: none; font-weight: bold; cursor: pointer; }
        .l-btn.active { background: var(--c-blue); color: white; }

        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 2000; backdrop-filter: blur(2px); }
        .modal-body { background: white; width: 85%; padding: 25px; border-radius: 20px; text-align: center; box-shadow: 0 20px 40px rgba(0,0,0,0.2); }
        .timer-row { display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #eee; color: var(--c-blue); font-weight: 600; font-variant-numeric: tabular-nums; }
        
        #scr-win { align-items: center; justify-content: center; text-align: center; background: rgba(255,255,255,0.95); backdrop-filter: blur(5px); z-index: 1500; overflow: hidden; }
        #confetti-canvas { position: absolute; inset: 0; pointer-events: none; width: 100%; height: 100%; z-index: 1; }
        .win-content { position: relative; z-index: 10; display: flex; flex-direction: column; align-items: center; }
        .win-title { font-size: 3.5rem; font-weight: 900; color: var(--c-blue); margin-bottom: 20px; transform: scale(0); transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .win-title.show { transform: scale(1); }
        .coins-earned { font-size: 1.5rem; color: var(--c-gold); margin: 10px 0; font-weight: bold; display: flex; align-items: center; justify-content: center; gap: 8px; }
        
        .big-btn { padding: 15px 30px; border-radius: 15px; border: none; font-size: 1.2rem; font-weight: bold; cursor: pointer; box-shadow: 0 8px 20px rgba(0,0,0,0.1); }
        .btn-menu { background: var(--c-gray); color: #555; }
        .btn-next { background: var(--c-blue); color: white; }
    </style>
</head>
<body>

<div id="app">
    <div class="top-ui" id="main-header">
        <div class="top-left-group">
            <div class="lives-pill" onclick="App.showTimers()">
                <svg width="20" height="20" fill="var(--c-red)" viewBox="0 0 24 24"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
                <span id="lives-count" style="font-weight: 800; color: var(--c-blue);">3</span>
            </div>
            <div class="coins-pill">
                <svg class="coins-icon" width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm.31-8.86c-1.77-.45-2.34-.94-2.34-1.67 0-.84.79-1.43 2.1-1.43 1.38 0 1.9.66 1.94 1.64h1.71c-.05-1.34-.87-2.57-2.49-2.97V5H10.9v1.69c-1.51.32-2.72 1.3-2.72 2.81 0 1.79 1.49 2.69 3.66 3.21 1.95.46 2.34 1.15 2.34 1.87 0 .53-.39 1.39-2.1 1.39-1.6 0-2.23-.72-2.32-1.64H8.04c.1 1.7 1.36 2.66 2.86 2.97V19h2.34v-1.67c1.52-.29 2.72-1.16 2.73-2.77-.01-2.2-1.9-2.96-3.66-3.42z"/></svg>
                <span id="coins-count" style="font-weight: 800; color: var(--c-gold);">0</span>
            </div>
        </div>
        <div id="btn-back" style="display:none" onclick="App.nav('home')">
            <svg width="30" height="30" fill="var(--c-blue)" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </div>
    </div>

    <div id="scr-home" class="screen active">
        <div class="logo">Arrows</div>
        <div id="lvl-label" style="margin-bottom: 10px; font-weight: bold; color: var(--c-blue); opacity: 0.6;">LEVEL 1</div>
        <div class="tg-info" id="tg-info" style="display: none;">
            <div id="nickname-display" style="font-weight: bold; margin-bottom: 5px;"></div>
            <div style="font-size: 0.9rem; color: #666;" id="tg-connected">Connected to Telegram</div>
        </div>
        <button id="btn-connect-tg" style="display:none; padding:10px 20px; background:#0088cc; color:white; border:none; border-radius:10px;" onclick="App.connectTelegram()">Connect Telegram</button>
        <div class="play-btn" onclick="App.play()">
            <svg width="40" height="40" fill="white" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
        </div>
        <div class="stats-row">
            <button onclick="App.nav('stats')" style="padding:10px 20px; background:var(--c-blue); color:white; border:none; border-radius:10px;">Stats</button>
            <button onclick="App.nav('shop')" style="padding:10px 20px; background:var(--c-gold); color:white; border:none; border-radius:10px;">Shop</button>
        </div>
    </div>

    <div id="scr-game" class="screen"><div class="board-zone"><div id="board"></div></div></div>
    
    <div id="scr-win" class="screen">
        <canvas id="confetti-canvas"></canvas>
        <div class="win-content">
            <div id="win-msg" class="win-title">Victory!</div>
            <div class="coins-earned">+<span id="coins-earned-amount">20</span></div>
            <div style="display:flex; gap:20px; margin-top:20px;">
                <button class="big-btn btn-menu" onclick="App.nav('home')">Menu</button>
                <button class="big-btn btn-next" onclick="App.nextLvl()">Next</button>
            </div>
        </div>
    </div>

    <div class="nav-bar">
        <div class="nav-icon" onclick="App.nav('map')"><svg width="28" height="28" fill="currentColor" viewBox="0 0 24 24"><path d="M4 15h2v-2H4v2zm0 4h2v-2H4v2zm0-8h2V9H4v2zm4 4h12v-2H8v2zm0 4h12v-2H8v2zm0-8h12V9H8v2zM4 5h16V3H4v2z"/></svg></div>
        <div class="nav-icon active" id="n-home" onclick="App.nav('home')"><svg width="28" height="28" fill="currentColor" viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg></div>
        <div class="nav-icon" onclick="App.nav('stats')"><svg width="28" height="28" fill="currentColor" viewBox="0 0 24 24"><path d="M16 11V3H8v6H2v12h20V11h-6zm-6-6h4v14h-4V5zm-6 6h4v8H4v-8zm16 8h-4v-6h4v6z"/></svg></div>
        <div class="nav-icon" onclick="App.nav('set')"><svg width="28" height="28" fill="currentColor" viewBox="0 0 24 24"><path d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58a.49.49 0 00.12-.61l-1.92-3.32a.488.488 0 00-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54a.484.484 0 00-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.05.3-.09.63-.09.94s.02.64.07.94l-2.03 1.58a.49.49 0 00-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.58 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/></svg></div>
    </div>
</div>

<script>
const API_BASE_URL = 'https://malollas.pythonanywhere.com/api'; 

const App = {
    state: { maxLvl: 1, lives: 3, coins: 0, lang: 'ru', sound: true, vib: true, tgUserId: null, tgUsername: null, tgConnected: false },
    curNum: 1, boardSize: 5,
    
    init() {
        const d = localStorage.getItem('arrows_pro_v19');
        if (d) this.state = {...this.state, ...JSON.parse(d)};
        this.initTelegramWebApp();
        this.updateUI();
    },

    initTelegramWebApp() {
        if (window.Telegram?.WebApp) {
            const tg = window.Telegram.WebApp;
            tg.ready(); tg.expand();
            const user = tg.initDataUnsafe?.user;
            if (user) {
                this.state.tgUserId = user.id;
                this.state.tgUsername = user.username || user.first_name;
                this.state.tgConnected = true;
                this.loadUserData(); // <-- КЛЮЧЕВОЙ МОМЕНТ: Сразу идем за данными
            }
        }
    },

    async loadUserData() {
        if (!this.state.tgUserId) return;
        try {
            const res = await fetch(`${API_BASE_URL}/get_user`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ user_id: this.state.tgUserId, username: this.state.tgUsername })
            });
            const data = await res.json();
            if (data.success) {
                this.state.coins = data.user.coins;
                this.updateUI();
            }
        } catch (e) { console.error(e); }
    },

    updateUI() {
        document.getElementById('lives-count').innerText = this.state.lives;
        document.getElementById('coins-count').innerText = this.state.coins;
        document.getElementById('lvl-label').innerText = `LEVEL ${this.state.maxLvl}`;
        if (this.state.tgConnected) {
            document.getElementById('tg-info').style.display = 'block';
            document.getElementById('nickname-display').innerText = `@${this.state.tgUsername}`;
        }
    },

    nav(s) {
        document.querySelectorAll('.screen').forEach(el => el.classList.remove('active'));
        const target = document.getElementById('scr-' + s);
        if (target) target.classList.add('active');
        this.updateUI();
    },

    play() {
        if (this.state.lives <= 0) return alert('No lives!');
        this.nav('game');
        this.renderBoard();
    },

    renderBoard() {
        const b = document.getElementById('board');
        b.innerHTML = '';
        b.style.width = '300px'; b.style.height = '300px';
        const types = ['U','R','D','L'];
        const arrow = document.createElement('div');
        arrow.className = 'arrow-box';
        arrow.style.width = '60px'; arrow.style.height = '60px';
        arrow.style.left = '120px'; arrow.style.top = '120px';
        arrow.innerHTML = `<svg viewBox="0 0 100 100" class="arrow-svg"><path class="p-line" d="M50 80 L50 20"/><path class="p-head" d="M30 40 L50 20 L70 40"/></svg>`;
        arrow.onclick = () => this.win();
        b.appendChild(arrow);
    },

    win() {
        this.nav('win');
        document.getElementById('win-title')?.classList.add('show');
    },

    nextLvl() { this.state.maxLvl++; this.nav('home'); }
};

window.onload = () => App.init();
</script>
</body>
</html>
