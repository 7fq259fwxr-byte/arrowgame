<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Arrows Pro Ultra</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --primary: #00f2ff;
            --secondary: #0062ff;
            --bg: #050505;
        }

        body {
            margin: 0;
            padding: 0;
            background: var(--bg);
            color: white;
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            overflow: hidden;
            touch-action: none;
        }

        #game-container {
            position: relative;
            width: 100vw;
            height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        canvas {
            display: block;
            max-width: 100%;
            max-height: 100%;
        }

        #ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 10;
        }

        .menu-screen {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80%;
            max-width: 400px;
            background: rgba(0, 0, 0, 0.9);
            border: 2px solid var(--primary);
            border-radius: 20px;
            padding: 30px;
            text-align: center;
            pointer-events: auto;
            box-shadow: 0 0 20px var(--secondary);
        }

        button {
            background: linear-gradient(45deg, var(--secondary), var(--primary));
            border: none;
            color: white;
            padding: 15px 40px;
            font-size: 20px;
            font-weight: bold;
            border-radius: 30px;
            cursor: pointer;
            margin-top: 20px;
            text-transform: uppercase;
            letter-spacing: 2px;
            transition: transform 0.2s;
        }

        button:active {
            transform: scale(0.95);
        }

        .hidden { display: none !important; }
        
        #stats {
            position: absolute;
            top: 10px;
            left: 10px;
            font-size: 18px;
            color: var(--primary);
            text-shadow: 0 0 5px black;
        }

        #user-info {
            position: absolute;
            top: 10px;
            right: 10px;
            text-align: right;
            font-size: 14px;
        }
    </style>
</head>
<body>

<div id="game-container">
    <canvas id="gameCanvas"></canvas>
    
    <div id="ui-layer">
        <div id="stats" class="hidden">
            Счет: <span id="currentScore">0</span><br>
            Рекорд: <span id="bestScore">0</span>
        </div>

        <div id="user-info">
            <span id="username">Загрузка...</span>
        </div>

        <div id="main-menu" class="menu-screen">
            <h1 style="color: var(--primary); margin-top: 0;">ARROWS PRO</h1>
            <p>Нажимай на стрелки в ритм!</p>
            <button onclick="startGame()">ИГРАТЬ</button>
        </div>

        <div id="game-over" class="menu-screen hidden">
            <h2 style="color: #ff4444;">ИГРА ОКОНЧЕНА</h2>
            <p>Ваш счет: <span id="finalScore">0</span></p>
            <button onclick="startGame()">ЕЩЕ РАЗ</button>
        </div>
    </div>
</div>

<script>
    const tg = window.Telegram.WebApp;
    tg.expand();

    // КОНФИГУРАЦИЯ - Твой сервер на PythonAnywhere
    const API_BASE_URL = 'https://malollas.pythonanywhere.com/api';
    
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    
    let gameState = 'menu';
    let score = 0;
    let currentUser = { username: 'Гость', score: 0 };
    let arrows = [];
    let lastArrowTime = 0;
    let isTelegram = false;

    // Настройка размеров
    function resize() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
    }
    window.addEventListener('resize', resize);
    resize();

    // Инициализация игрока и связи с сервером
    async function initPlayer() {
        const user = tg.initDataUnsafe?.user;
        const usernameEl = document.getElementById('username');

        if (user) {
            try {
                const response = await fetch(`${API_BASE_URL}/get_user`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: user.id,
                        username: user.username || user.first_name
                    })
                });
                const data = await response.json();
                if (data.success) {
                    currentUser = data.user;
                    isTelegram = true;
                    usernameEl.innerText = currentUser.username;
                    document.getElementById('bestScore').innerText = currentUser.score;
                    
                    // ЗАПУСКАЕМ ДВИЖОК
                    initGame();
                }
            } catch (e) {
                console.error("Ошибка API:", e);
                usernameEl.innerText = "Demo Mode";
                initGame();
            }
        } else {
            usernameEl.innerText = "Браузер (Demo)";
            initGame();
        }
    }

    // Логика стрелок
    class Arrow {
        constructor() {
            this.x = Math.random() * (canvas.width - 60) + 30;
            this.y = canvas.height + 50;
            this.speed = 3 + (score / 10);
            this.type = Math.floor(Math.random() * 4); // 0: Up, 1: Right, 2: Down, 3: Left
            this.size = 50;
        }

        update() {
            this.y -= this.speed;
            return this.y < -50;
        }

        draw() {
            ctx.save();
            ctx.translate(this.x, this.y);
            ctx.rotate(this.type * Math.PI / 2);
            
            ctx.beginPath();
            ctx.moveTo(0, -this.size/2);
            ctx.lineTo(this.size/2, this.size/2);
            ctx.lineTo(-this.size/2, this.size/2);
            ctx.closePath();
            
            ctx.fillStyle = '#00f2ff';
            ctx.shadowBlur = 15;
            ctx.shadowColor = '#0062ff';
            ctx.fill();
            ctx.restore();
        }
    }

    function initGame() {
        console.log("Game Engine Ready");
        requestAnimationFrame(gameLoop);
    }

    function startGame() {
        gameState = 'playing';
        score = 0;
        arrows = [];
        document.getElementById('main-menu').classList.add('hidden');
        document.getElementById('game-over').classList.add('hidden');
        document.getElementById('stats').classList.remove('hidden');
        document.getElementById('currentScore').innerText = "0";
    }

    function gameOver() {
        gameState = 'over';
        document.getElementById('game-over').classList.remove('hidden');
        document.getElementById('finalScore').innerText = score;
        saveScore();
    }

    async function saveScore() {
        if (!isTelegram) return;
        try {
            await fetch(`${API_BASE_URL}/update_score`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    user_id: tg.initDataUnsafe.user.id,
                    score: score
                })
            });
        } catch (e) { console.error("Score save error", e); }
    }

    function gameLoop(time) {
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        if (gameState === 'playing') {
            // Создание новых стрелок
            if (time - lastArrowTime > 1000 - (score * 5)) {
                arrows.push(new Arrow());
                lastArrowTime = time;
            }

            // Обновление и отрисовка
            for (let i = arrows.length - 1; i >= 0; i--) {
                const arrow = arrows[i];
                arrow.draw();
                if (arrow.update()) {
                    arrows.splice(i, 1);
                    gameOver(); // Пропустил стрелку - конец
                }
            }
        }

        requestAnimationFrame(gameLoop);
    }

    // Обработка нажатий (Сенсор и Клавиатура)
    function handleAction(type) {
        if (gameState !== 'playing') return;
        
        let hit = false;
        for (let i = 0; i < arrows.length; i++) {
            if (arrows[i].type === type && arrows[i].y < 200) {
                arrows.splice(i, 1);
                score++;
                document.getElementById('currentScore').innerText = score;
                hit = true;
                break;
            }
        }
    }

    window.addEventListener('keydown', (e) => {
        const keys = { 'ArrowUp': 0, 'ArrowRight': 1, 'ArrowDown': 2, 'ArrowLeft': 3 };
        if (keys[e.key] !== undefined) handleAction(keys[e.key]);
    });

    // Упрощенное управление для тачскрина
    canvas.addEventListener('touchstart', (e) => {
        const touch = e.touches[0];
        const x = touch.clientX;
        const y = touch.clientY;

        if (y < canvas.height / 3) handleAction(0); // Top
        else if (y > (canvas.height / 3) * 2) handleAction(2); // Bottom
        else if (x < canvas.width / 2) handleAction(3); // Left
        else handleAction(1); // Right
    });

    // Запуск процесса авторизации
    initPlayer();

</script>
</body>
</html>
