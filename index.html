<!DOCTYPE html>
<html lang="ru">
<head>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Arrows Pro Ultra Debug</title>
    <style>
        :root { --c-blue: #003366; --c-bg: #f4f6f9; --c-gray: #e0e0e0; --c-red: #ff4d4d; --c-green: #2ecc71; --c-gold: #FFD700; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; margin: 0; padding: 0; }
        body { background: var(--c-bg); font-family: -apple-system, sans-serif; overflow: hidden; height: 100vh; display: flex; justify-content: center; }
        #app { width: 100%; max-width: 500px; height: 100%; position: relative; display: flex; flex-direction: column; }
        .screen { position: absolute; inset: 0; display: none; flex-direction: column; background: var(--c-bg); z-index: 10; width: 100%; height: 100%; }
        .screen.active { display: flex; }
        .top-ui { padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; min-height: 70px; z-index: 100; }
        .lives-pill { background: white; padding: 8px 15px; border-radius: 25px; display: flex; align-items: center; gap: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
        .board-zone { flex: 1; display: flex; align-items: center; justify-content: center; padding: 20px; width: 100%; position: relative; }
        #board { background: white; border-radius: 25px; position: relative; box-shadow: 0 10px 30px rgba(0,0,0,0.1); margin: auto; min-width: 250px; min-height: 250px; }
        .arrow-box { position: absolute; cursor: pointer; z-index: 50 !important; display: block !important; opacity: 1 !important; }
        .arrow-svg { width: 100%; height: 100%; overflow: visible; }
        .p-line { fill: none; stroke: var(--c-blue); stroke-width: 6; stroke-linecap: round; }
        .p-head { fill: var(--c-blue); }
        .debug-info { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #ccc; font-size: 10px; pointer-events: none; text-align: center; width: 100%; }
        #scr-home { align-items: center; justify-content: center; }
        .play-btn { width: 100px; height: 100px; background: var(--c-blue); border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        .version-label { position: absolute; bottom: 90px; right: 15px; font-size: 11px; color: #999; font-weight: bold; }
        .nav-bar { position: absolute; bottom: 0; width: 100%; height: 75px; background: white; display: flex; justify-content: space-around; align-items: center; z-index: 1000; }
        .nav-icon { opacity: 0.3; color: var(--c-blue); }
        .nav-icon.active { opacity: 1; }
    </style>
</head>
<body>

<div id="app">
    <div class="top-ui">
        <div class="lives-pill">
            <span id="lives-count" style="font-weight: 800; color: var(--c-blue);">3</span>
        </div>
        <div id="btn-back" style="display:none" onclick="location.reload()">BACK</div>
    </div>

    <div id="scr-home" class="screen active">
        <h1 style="color:var(--c-blue); font-size: 3rem;">Arrows</h1>
        <div class="play-btn" onclick="App.play()">
            <svg width="40" height="40" fill="white" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
        </div>
        <div class="version-label">v1.0.3 DEBUG</div>
    </div>

    <div id="scr-game" class="screen">
        <div class="board-zone">
            <div id="board">
                <div class="debug-info" id="debug-text">Waiting for start...</div>
            </div>
        </div>
    </div>
    
    <div class="nav-bar">
        <div class="nav-icon active">HOME</div>
        <div class="nav-icon">MAP</div>
        <div class="nav-icon">STATS</div>
    </div>
</div>

<script>
const App = {
    state: { lives: 3, maxLvl: 1 },
    curNum: 1,

    init() {
        if (window.Telegram?.WebApp) {
            window.Telegram.WebApp.ready();
            window.Telegram.WebApp.expand();
        }
    },

    log(msg) {
        console.log(msg);
        const el = document.getElementById('debug-text');
        if(el) el.innerText += "\n" + msg;
    },

    play(n = 1) {
        document.getElementById('scr-home').classList.remove('active');
        document.getElementById('scr-game').classList.add('active');
        document.getElementById('btn-back').style.display = 'block';
        this.loadLvl(n);
    },

    loadLvl(n) {
        const b = document.getElementById('board');
        const dbg = document.getElementById('debug-text');
        dbg.innerText = "Level " + n + " loading...";
        b.innerHTML = '';
        b.appendChild(dbg);

        // Расчет размеров
        let w = b.parentElement.clientWidth - 40;
        if(w <= 0) w = window.innerWidth - 40;
        const size = Math.min(w, 400);
        
        b.style.width = size + 'px';
        b.style.height = size + 'px';
        
        this.log("Board size: " + size);

        const grid = 5;
        const cellSize = size / grid;
        const arrowSize = cellSize * 0.7;

        // Генерация (упрощенная для теста)
        const testArrows = [
            {id: 1, x: 0, y: 0, dir: 'R', dx: 1, dy: 0},
            {id: 2, x: 2, y: 2, dir: 'U', dx: 0, dy: -1},
            {id: 3, x: 4, y: 4, dir: 'L', dx: -1, dy: 0}
        ];

        this.log("Arrows to draw: " + testArrows.length);

        testArrows.forEach(a => {
            const wrap = document.createElement('div');
            wrap.className = 'arrow-box';
            
            const left = a.x * cellSize + (cellSize - arrowSize) / 2;
            const top = a.y * cellSize + (cellSize - arrowSize) / 2;
            
            wrap.style.cssText = `
                width: ${arrowSize}px; 
                height: ${arrowSize}px; 
                left: ${left}px; 
                top: ${top}px;
                position: absolute;
                z-index: 100;
            `;

            // Рисуем простую стрелку через SVG
            let points, headX, headY, angle;
            if(a.dir === 'R') { points = `M 0 ${arrowSize/2} L ${arrowSize} ${arrowSize/2}`; headX = arrowSize; headY = arrowSize/2; angle = 0; }
            if(a.dir === 'L') { points = `M ${arrowSize} ${arrowSize/2} L 0 ${arrowSize/2}`; headX = 0; headY = arrowSize/2; angle = 180; }
            if(a.dir === 'U') { points = `M ${arrowSize/2} ${arrowSize} L ${arrowSize/2} 0`; headX = arrowSize/2; headY = 0; angle = -90; }
            if(a.dir === 'D') { points = `M ${arrowSize/2} 0 L ${arrowSize/2} ${arrowSize}`; headX = arrowSize/2; headY = arrowSize; angle = 90; }

            wrap.innerHTML = `
                <svg width="${arrowSize}" height="${arrowSize}" style="overflow:visible">
                    <path d="${points}" stroke="#003366" stroke-width="4" fill="none" />
                    <polygon points="-5,-5 5,0 -5,5" fill="#003366" 
                        transform="translate(${headX},${headY}) rotate(${angle})" />
                </svg>
            `;
            
            wrap.onclick = () => { wrap.style.display = 'none'; };
            b.appendChild(wrap);
        });
        
        this.log("Done. Children: " + b.children.length);
    }
};

window.onload = () => App.init();
</script>
</body>
</html>
