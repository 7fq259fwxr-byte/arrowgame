<!DOCTYPE html>
<html lang="ru">
<head>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Arrows Game</title>
    <style>
        :root {
            --c-blue: #003366;
            --c-bg: #f4f6f9;
            --c-gray: #e0e0e0;
            --c-red: #ff4d4d;
            --c-green: #2ecc71;
            --c-gold: #FFD700;
        }
        
        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
            margin: 0;
            padding: 0;
        }
        
        body {
            background: var(--c-bg);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            overflow: hidden;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        #app {
            width: 100%;
            max-width: 500px;
            height: 100%;
            position: relative;
            display: flex;
            flex-direction: column;
            background: var(--c-bg);
        }
        
        .screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none;
            flex-direction: column;
            background: var(--c-bg);
            z-index: 10;
            padding-bottom: 75px; /* Для навбара */
        }
        
        .screen.active {
            display: flex;
        }
        
        .header {
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            min-height: 70px;
            z-index: 100;
            background: var(--c-bg);
        }
        
        .stats-container {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .stat-pill {
            background: white;
            padding: 8px 15px;
            border-radius: 25px;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            font-weight: bold;
        }
        
        .hearts-pill {
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .hearts-pill:active {
            transform: scale(0.95);
        }
        
        .heart-icon {
            color: var(--c-red);
        }
        
        .coin-icon {
            color: var(--c-gold);
        }
        
        #btn-back {
            display: none;
            cursor: pointer;
        }
        
        /* HOME SCREEN */
        #scr-home {
            align-items: center;
            justify-content: center;
            text-align: center;
        }
        
        .logo {
            font-size: 4rem;
            font-weight: 900;
            color: var(--c-blue);
            margin-bottom: 5px;
        }
        
        .level-indicator {
            margin-bottom: 20px;
            font-weight: bold;
            color: var(--c-blue);
            opacity: 0.7;
        }
        
        .play-button {
            width: 100px;
            height: 100px;
            background: var(--c-blue);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 10px 20px rgba(0,51,102,0.2);
            cursor: pointer;
            margin-bottom: 30px;
            transition: transform 0.2s;
        }
        
        .play-button:active {
            transform: scale(0.95);
        }
        
        .play-icon {
            color: white;
            margin-left: 5px;
        }
        
        .menu-buttons {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }
        
        .menu-btn {
            padding: 12px 25px;
            border-radius: 12px;
            border: none;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .menu-btn:active {
            transform: scale(0.95);
        }
        
        .menu-btn.stats {
            background: var(--c-blue);
            color: white;
        }
        
        .menu-btn.shop {
            background: var(--c-gold);
            color: white;
        }
        
        /* GAME SCREEN */
        #scr-game {
            padding: 0;
        }
        
        .board-container {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            width: 100%;
        }
        
        #board {
            background: white;
            border-radius: 25px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            border: 3px solid transparent;
        }
        
        .grid-line {
            position: absolute;
            background: rgba(0, 51, 102, 0.05);
            z-index: 1;
        }
        
        /* ARROWS - ГАРАНТИРОВАННО РАБОТАЮТ В TELEGRAM */
        .arrow {
            position: absolute;
            z-index: 2;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .arrow-inner {
            position: relative;
            width: 100%;
            height: 100%;
        }
        
        .arrow-line {
            position: absolute;
            background-color: var(--c-blue);
            border-radius: 3px;
        }
        
        .arrow-head {
            position: absolute;
            width: 0;
            height: 0;
            border-style: solid;
        }
        
        /* Направления стрелок */
        .arrow.right .arrow-line {
            width: 70%;
            height: 6px;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
        }
        
        .arrow.right .arrow-head {
            right: 0;
            top: 50%;
            transform: translateY(-50%);
            border-width: 8px 0 8px 12px;
            border-color: transparent transparent transparent var(--c-blue);
        }
        
        .arrow.left .arrow-line {
            width: 70%;
            height: 6px;
            right: 0;
            top: 50%;
            transform: translateY(-50%);
        }
        
        .arrow.left .arrow-head {
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            border-width: 8px 12px 8px 0;
            border-color: transparent var(--c-blue) transparent transparent;
        }
        
        .arrow.up .arrow-line {
            width: 6px;
            height: 70%;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
        }
        
        .arrow.up .arrow-head {
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            border-width: 0 8px 12px 8px;
            border-color: transparent transparent var(--c-blue) transparent;
        }
        
        .arrow.down .arrow-line {
            width: 6px;
            height: 70%;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
        }
        
        .arrow.down .arrow-head {
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            border-width: 12px 8px 0 8px;
            border-color: var(--c-blue) transparent transparent transparent;
        }
        
        /* Эффекты ошибки */
        .arrow.error .arrow-line {
            background-color: var(--c-red) !important;
        }
        
        .arrow.error .arrow-head {
            border-left-color: var(--c-red) !important;
            border-right-color: var(--c-red) !important;
            border-top-color: var(--c-red) !important;
            border-bottom-color: var(--c-red) !important;
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        
        .shake {
            animation: shake 0.3s ease-in-out;
        }
        
        /* VICTORY SCREEN */
        #scr-win {
            align-items: center;
            justify-content: center;
            text-align: center;
            background: rgba(255, 255, 255, 0.95);
        }
        
        #confetti-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
        }
        
        .win-content {
            position: relative;
            z-index: 2;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .win-title {
            font-size: 3rem;
            font-weight: 900;
            color: var(--c-blue);
            margin-bottom: 20px;
            animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        
        @keyframes popIn {
            0% { transform: scale(0); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        
        .coins-earned {
            font-size: 1.5rem;
            color: var(--c-gold);
            margin: 10px 0;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .win-buttons {
            display: flex;
            gap: 15px;
            margin-top: 30px;
        }
        
        .win-btn {
            padding: 15px 25px;
            border-radius: 12px;
            border: none;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .win-btn:active {
            transform: scale(0.95);
        }
        
        .win-btn.menu {
            background: var(--c-gray);
            color: #555;
        }
        
        .win-btn.next {
            background: var(--c-blue);
            color: white;
        }
        
        /* STATS SCREEN */
        #scr-stats {
            padding: 20px;
            overflow-y: auto;
        }
        
        .stats-title {
            color: var(--c-blue);
            margin-bottom: 20px;
            font-size: 1.8rem;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            margin-bottom: 20px;
        }
        
        .stat-row {
            display: flex;
            justify-content: space-between;
            margin: 10px 0;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .stat-label {
            color: #666;
        }
        
        .stat-value {
            font-weight: bold;
            color: var(--c-blue);
        }
        
        /* SHOP SCREEN */
        #scr-shop {
            padding: 20px;
            overflow-y: auto;
        }
        
        .shop-title {
            color: var(--c-blue);
            margin-bottom: 20px;
            font-size: 1.8rem;
        }
        
        .shop-placeholder {
            text-align: center;
            padding: 40px 20px;
            color: #666;
        }
        
        /* SETTINGS SCREEN */
        #scr-settings {
            padding: 20px;
            overflow-y: auto;
        }
        
        .settings-title {
            color: var(--c-blue);
            margin-bottom: 20px;
            font-size: 1.8rem;
        }
        
        .settings-row {
            background: white;
            margin: 10px 0;
            padding: 15px 20px;
            border-radius: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .toggle-switch {
            width: 50px;
            height: 26px;
            background: var(--c-gray);
            border-radius: 13px;
            position: relative;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .toggle-switch.active {
            background: var(--c-blue);
        }
        
        .toggle-knob {
            position: absolute;
            top: 3px;
            left: 3px;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s;
        }
        
        .toggle-switch.active .toggle-knob {
            transform: translateX(24px);
        }
        
        .language-buttons {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }
        
        .lang-btn {
            padding: 8px 15px;
            border: 2px solid var(--c-blue);
            border-radius: 8px;
            background: none;
            color: var(--c-blue);
            font-weight: bold;
            cursor: pointer;
        }
        
        .lang-btn.active {
            background: var(--c-blue);
            color: white;
        }
        
        /* NAVIGATION BAR */
        .navbar {
            position: fixed;
            bottom: 0;
            width: 100%;
            max-width: 500px;
            height: 75px;
            background: white;
            display: flex;
            justify-content: space-around;
            align-items: center;
            z-index: 1000;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
        }
        
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            opacity: 0.3;
            transition: opacity 0.3s;
        }
        
        .nav-item.active {
            opacity: 1;
        }
        
        .nav-icon {
            width: 24px;
            height: 24px;
            margin-bottom: 4px;
        }
        
        .nav-label {
            font-size: 0.7rem;
            font-weight: 500;
        }
        
        /* MODAL */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }
        
        .modal-content {
            background: white;
            width: 85%;
            padding: 25px;
            border-radius: 20px;
            text-align: center;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
        }
        
        .modal-title {
            color: var(--c-blue);
            margin-bottom: 15px;
            font-size: 1.5rem;
        }
        
        .timers-list {
            margin: 20px 0;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .timer-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
            color: var(--c-blue);
            font-weight: 600;
        }
        
        .modal-btn {
            padding: 12px 30px;
            background: var(--c-blue);
            color: white;
            border: none;
            border-radius: 12px;
            font-weight: bold;
            cursor: pointer;
        }
        
        /* TELEGRAM INFO */
        .telegram-info {
            background: rgba(0, 136, 204, 0.1);
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            text-align: center;
        }
        
        .nickname {
            font-weight: bold;
            color: var(--c-blue);
            margin-bottom: 5px;
        }
        
        .tg-status {
            font-size: 0.9rem;
            color: #666;
        }
        
        .connect-btn {
            padding: 12px 25px;
            background: #0088cc;
            color: white;
            border: none;
            border-radius: 10px;
            font-weight: bold;
            cursor: pointer;
            margin: 10px 0;
        }
        
        /* LOADING */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100%;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--c-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* DEBUG INFO */
        .debug-info {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.8rem;
            z-index: 3000;
            display: none;
        }
    </style>
</head>
<body>
    <div id="app">
        <!-- DEBUG INFO -->
        <div class="debug-info" id="debug-info"></div>
        
        <!-- HEADER -->
        <div class="header" id="header">
            <div class="stats-container">
                <div class="stat-pill hearts-pill" id="hearts-pill">
                    <svg class="heart-icon" width="20" height="20" viewBox="0 0 24 24">
                        <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
                    </svg>
                    <span id="hearts-count">3</span>
                </div>
                <div class="stat-pill" id="coins-pill">
                    <svg class="coin-icon" width="20" height="20" viewBox="0 0 24 24">
                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm.31-8.86c-1.77-.45-2.34-.94-2.34-1.67 0-.84.79-1.43 2.1-1.43 1.38 0 1.9.66 1.94 1.64h1.71c-.05-1.34-.87-2.57-2.49-2.97V5H10.9v1.69c-1.51.32-2.72 1.3-2.72 2.81 0 1.79 1.49 2.69 3.66 3.21 1.95.46 2.34 1.15 2.34 1.87 0 .53-.39 1.39-2.1 1.39-1.6 0-2.23-.72-2.32-1.64H8.04c.1 1.7 1.36 2.66 2.86 2.97V19h2.34v-1.67c1.52-.29 2.72-1.16 2.73-2.77-.01-2.2-1.9-2.96-3.66-3.42z"/>
                    </svg>
                    <span id="coins-count">0</span>
                </div>
            </div>
            <div id="btn-back">
                <svg width="30" height="30" fill="var(--c-blue)" viewBox="0 0 24 24">
                    <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                </svg>
            </div>
        </div>
        
        <!-- SCREENS -->
        <div id="scr-home" class="screen active">
            <div class="logo">Arrows</div>
            <div class="level-indicator" id="level-indicator">LEVEL 1</div>
            
            <div class="telegram-info" id="telegram-info" style="display: none;">
                <div class="nickname" id="nickname"></div>
                <div class="tg-status" id="tg-status">Connected to Telegram</div>
            </div>
            <button class="connect-btn" id="connect-btn" style="display: none;" onclick="Game.connectTelegram()">Connect Telegram</button>
            
            <div class="play-button" onclick="Game.startLevel()">
                <svg class="play-icon" width="40" height="40" viewBox="0 0 24 24">
                    <path d="M8 5v14l11-7z"/>
                </svg>
            </div>
            
            <div class="menu-buttons">
                <button class="menu-btn stats" onclick="Game.showScreen('stats')">Stats</button>
                <button class="menu-btn shop" onclick="Game.showScreen('shop')">Shop</button>
            </div>
            
            <!-- Кнопка для сброса прогресса (только для отладки) -->
            <button onclick="Game.resetProgress()" style="margin-top: 20px; padding: 8px 15px; background: #ff4d4d; color: white; border: none; border-radius: 8px; font-size: 0.9rem;">Reset Progress</button>
        </div>
        
        <div id="scr-game" class="screen">
            <div class="board-container">
                <div id="board"></div>
            </div>
        </div>
        
        <div id="scr-win" class="screen">
            <canvas id="confetti-canvas"></canvas>
            <div class="win-content">
                <div class="win-title" id="win-title">Victory!</div>
                <div class="coins-earned" id="coins-earned">
                    <svg class="coin-icon" width="24" height="24" viewBox="0 0 24 24">
                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm.31-8.86c-1.77-.45-2.34-.94-2.34-1.67 0-.84.79-1.43 2.1-1.43 1.38 0 1.9.66 1.94 1.64h1.71c-.05-1.34-.87-2.57-2.49-2.97V5H10.9v1.69c-1.51.32-2.72 1.3-2.72 2.81 0 1.79 1.49 2.69 3.66 3.21 1.95.46 2.34 1.15 2.34 1.87 0 .53-.39 1.39-2.1 1.39-1.6 0-2.23-.72-2.32-1.64H8.04c.1 1.7 1.36 2.66 2.86 2.97V19h2.34v-1.67c1.52-.29 2.72-1.16 2.73-2.77-.01-2.2-1.9-2.96-3.66-3.42z"/>
                    </svg>
                    +<span id="coins-earned-amount">20</span>
                </div>
                <div class="win-buttons">
                    <button class="win-btn menu" onclick="Game.showScreen('home')">Menu</button>
                    <button class="win-btn next" onclick="Game.nextLevel()">Next</button>
                </div>
            </div>
        </div>
        
        <div id="scr-stats" class="screen">
            <div class="stats-title">Statistics</div>
            <div class="stat-card">
                <div class="stat-row">
                    <span class="stat-label">Levels Passed:</span>
                    <span class="stat-value" id="stats-levels">0</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Total Coins:</span>
                    <span class="stat-value" id="stats-coins">0</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Global Rank:</span>
                    <span class="stat-value" id="stats-rank">-</span>
                </div>
            </div>
        </div>
        
        <div id="scr-shop" class="screen">
            <div class="shop-title">Shop</div>
            <div class="shop-placeholder">
                <div style="font-size: 1.2rem; margin-bottom: 15px;">Coming Soon!</div>
                <div>Connect Telegram for full features</div>
            </div>
        </div>
        
        <div id="scr-settings" class="screen">
            <div class="settings-title">Settings</div>
            <div class="settings-row">
                <span>Sound</span>
                <div class="toggle-switch" id="toggle-sound" onclick="Game.toggleSetting('sound')">
                    <div class="toggle-knob"></div>
                </div>
            </div>
            <div class="settings-row">
                <span>Vibration</span>
                <div class="toggle-switch" id="toggle-vibration" onclick="Game.toggleSetting('vibration')">
                    <div class="toggle-knob"></div>
                </div>
            </div>
            <div class="settings-row">
                <span>Language</span>
                <div class="language-buttons">
                    <button class="lang-btn" id="lang-ru" onclick="Game.setLanguage('ru')">RU</button>
                    <button class="lang-btn" id="lang-en" onclick="Game.setLanguage('en')">EN</button>
                    <button class="lang-btn" id="lang-zh" onclick="Game.setLanguage('zh')">ZH</button>
                </div>
            </div>
            <div class="settings-row">
                <span>Telegram Status:</span>
                <div id="tg-status-text">Not connected</div>
            </div>
        </div>
        
        <!-- NAVIGATION BAR -->
        <div class="navbar">
            <div class="nav-item" id="nav-home" onclick="Game.showScreen('home')">
                <svg class="nav-icon" fill="var(--c-blue)" viewBox="0 0 24 24">
                    <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/>
                </svg>
                <span class="nav-label">Home</span>
            </div>
            <div class="nav-item" id="nav-stats" onclick="Game.showScreen('stats')">
                <svg class="nav-icon" fill="var(--c-blue)" viewBox="0 0 24 24">
                    <path d="M16 11V3H8v6H2v12h20V11h-6zm-6-6h4v14h-4V5zm-6 6h4v8H4v-8zm16 8h-4v-6h4v6z"/>
                </svg>
                <span class="nav-label">Stats</span>
            </div>
            <div class="nav-item" id="nav-shop" onclick="Game.showScreen('shop')">
                <svg class="nav-icon" fill="var(--c-blue)" viewBox="0 0 24 24">
                    <path d="M7 18c-1.1 0-1.99.9-1.99 2S5.9 22 7 22s2-.9 2-2-.9-2-2-2zM1 2v2h2l3.6 7.59-1.35 2.45c-.16.28-.25.61-.25.96 0 1.1.9 2 2 2h12v-2H7.42c-.14 0-.25-.11-.25-.25l.03-.12.9-1.63h7.45c.75 0 1.41-.41 1.75-1.03l3.58-6.49c.08-.14.12-.31.12-.48 0-.55-.45-1-1-1H5.21l-.94-2H1zm16 16c-1.1 0-1.99.9-1.99 2s.89 2 1.99 2 2-.9 2-2-.9-2-2-2z"/>
                </svg>
                <span class="nav-label">Shop</span>
            </div>
            <div class="nav-item active" id="nav-settings" onclick="Game.showScreen('settings')">
                <svg class="nav-icon" fill="var(--c-blue)" viewBox="0 0 24 24">
                    <path d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58a.49.49 0 00.12-.61l-1.92-3.32a.488.488 0 00-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54a.484.484 0 00-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.05.3-.09.63-.09.94s.02.64.07.94l-2.03 1.58a.49.49 0 00-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.58 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/>
                </svg>
                <span class="nav-label">Settings</span>
            </div>
        </div>
        
        <!-- MODAL -->
        <div class="modal" id="modal-timers">
            <div class="modal-content">
                <div class="modal-title">Heart Recovery</div>
                <div class="timers-list" id="timers-list"></div>
                <button class="modal-btn" onclick="Game.hideModal()">OK</button>
            </div>
        </div>
    </div>

    <script>
        // Глобальная конфигурация
        const CONFIG = {
            API_URL: 'https://malollas.pythonanywhere.com/api',
            STORAGE_KEY: 'arrows_game_v3',
            DEFAULT_HEARTS: 3,
            HEART_RECOVERY_TIME: 20 * 60 * 1000, // 20 минут
            COINS_PER_LEVEL: 20
        };

        // Основной объект игры
        const Game = {
            // Состояние игры
            state: {
                currentLevel: 1,
                maxLevel: 1,
                hearts: CONFIG.DEFAULT_HEARTS,
                heartTimers: [],
                coins: 0,
                settings: {
                    sound: true,
                    vibration: true,
                    language: 'ru'
                },
                telegram: {
                    connected: false,
                    userId: null,
                    username: null
                },
                // Отдельное хранилище для уровней
                levels: {}
            },
            
            // Текущий игровой уровень
            currentBoard: null,
            boardSize: 5,
            
            // Таймеры
            gameTimer: null,
            
            // Инициализация
            async init() {
                console.log('Initializing game...');
                
                // Показать отладочную информацию
                this.showDebugInfo('Initializing...');
                
                try {
                    // Инициализация Telegram
                    await this.initTelegram();
                    
                    // Загрузка сохранений
                    await this.loadGameState();
                    
                    // Обновление интерфейса
                    this.updateUI();
                    
                    // Настройка интервалов
                    this.startTimers();
                    
                    // Инициализация конфетти
                    this.initConfetti();
                    
                    console.log('Game initialized successfully');
                    this.showDebugInfo('Game ready');
                    
                    // Гарантия отрисовки через 500ms
                    setTimeout(() => {
                        if (document.querySelector('.screen.active').id === 'scr-home') {
                            this.updateUI();
                        }
                    }, 500);
                    
                } catch (error) {
                    console.error('Initialization error:', error);
                    this.showDebugInfo('Init error: ' + error.message);
                }
            },
            
            // Инициализация Telegram
            async initTelegram() {
                if (window.Telegram && Telegram.WebApp) {
                    try {
                        Telegram.WebApp.ready();
                        Telegram.WebApp.expand();
                        
                        const user = Telegram.WebApp.initDataUnsafe?.user;
                        if (user) {
                            this.state.telegram.connected = true;
                            this.state.telegram.userId = user.id;
                            this.state.telegram.username = user.username || `User${user.id}`;
                            
                            // Обновляем интерфейс
                            document.getElementById('telegram-info').style.display = 'block';
                            document.getElementById('nickname').textContent = this.state.telegram.username;
                            document.getElementById('tg-status-text').textContent = `ID: ${user.id}`;
                            document.getElementById('connect-btn').style.display = 'none';
                            
                            // Загрузка данных с сервера
                            await this.loadTelegramData();
                        } else {
                            this.showTelegramConnectButton();
                        }
                    } catch (error) {
                        console.error('Telegram init error:', error);
                        this.showTelegramConnectButton();
                    }
                } else {
                    this.showTelegramConnectButton();
                }
            },
            
            // Показать кнопку подключения Telegram
            showTelegramConnectButton() {
                document.getElementById('connect-btn').style.display = 'block';
                document.getElementById('telegram-info').style.display = 'none';
            },
            
            // Загрузка данных Telegram
            async loadTelegramData() {
                if (!this.state.telegram.userId) return;
                
                try {
                    const response = await fetch(`${CONFIG.API_URL}/get_user`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            user_id: this.state.telegram.userId,
                            username: this.state.telegram.username
                        })
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        if (data.success) {
                            this.state.coins = data.user.coins || this.state.coins;
                            this.state.maxLevel = data.user.level || this.state.maxLevel;
                            await this.saveGameState();
                        }
                    }
                } catch (error) {
                    console.error('Error loading Telegram data:', error);
                }
            },
            
            // Загрузка состояния игры
            async loadGameState() {
                try {
                    // Пробуем загрузить из Telegram Cloud Storage
                    let savedState = null;
                    
                    if (window.Telegram?.WebApp?.CloudStorage) {
                        const keys = await Telegram.WebApp.CloudStorage.getKeys();
                        if (keys && keys.includes('game_state')) {
                            const data = await Telegram.WebApp.CloudStorage.getItem('game_state');
                            if (data) {
                                savedState = JSON.parse(data);
                            }
                        }
                    }
                    
                    // Если нет в Cloud Storage, пробуем localStorage
                    if (!savedState && localStorage) {
                        const data = localStorage.getItem(CONFIG.STORAGE_KEY);
                        if (data) {
                            savedState = JSON.parse(data);
                        }
                    }
                    
                    // Восстанавливаем состояние
                    if (savedState) {
                        // Обновляем основные поля
                        this.state.currentLevel = savedState.currentLevel || 1;
                        this.state.maxLevel = Math.max(this.state.maxLevel, savedState.maxLevel || 1);
                        this.state.hearts = savedState.hearts || CONFIG.DEFAULT_HEARTS;
                        this.state.coins = savedState.coins || 0;
                        this.state.heartTimers = savedState.heartTimers || [];
                        
                        // Настройки
                        if (savedState.settings) {
                            this.state.settings = { ...this.state.settings, ...savedState.settings };
                        }
                        
                        // Уровни (только для обычного браузера)
                        if (savedState.levels && !this.isTelegram()) {
                            this.state.levels = savedState.levels;
                        }
                        
                        console.log('Game state loaded:', this.state);
                    }
                    
                } catch (error) {
                    console.error('Error loading game state:', error);
                    // В случае ошибки сбрасываем к дефолтным значениям
                    this.resetGameState();
                }
            },
            
            // Сохранение состояния игры
            async saveGameState() {
                try {
                    const stateToSave = {
                        currentLevel: this.state.currentLevel,
                        maxLevel: this.state.maxLevel,
                        hearts: this.state.hearts,
                        coins: this.state.coins,
                        heartTimers: this.state.heartTimers,
                        settings: this.state.settings,
                        levels: this.state.levels
                    };
                    
                    // Сохраняем в Telegram Cloud Storage
                    if (window.Telegram?.WebApp?.CloudStorage) {
                        await Telegram.WebApp.CloudStorage.setItem('game_state', JSON.stringify(stateToSave));
                    }
                    
                    // Сохраняем в localStorage для совместимости
                    if (localStorage) {
                        localStorage.setItem(CONFIG.STORAGE_KEY, JSON.stringify(stateToSave));
                    }
                    
                    console.log('Game state saved');
                    
                } catch (error) {
                    console.error('Error saving game state:', error);
                }
            },
            
            // Сброс состояния игры
            resetGameState() {
                this.state = {
                    currentLevel: 1,
                    maxLevel: 1,
                    hearts: CONFIG.DEFAULT_HEARTS,
                    heartTimers: [],
                    coins: 0,
                    settings: {
                        sound: true,
                        vibration: true,
                        language: 'ru'
                    },
                    telegram: this.state.telegram,
                    levels: {}
                };
            },
            
            // Обновление интерфейса
            updateUI() {
                // Обновляем уровень
                document.getElementById('level-indicator').textContent = 
                    `LEVEL ${this.state.currentLevel}`;
                
                // Обновляем сердца
                document.getElementById('hearts-count').textContent = this.state.hearts;
                
                // Обновляем монеты
                document.getElementById('coins-count').textContent = this.state.coins;
                
                // Обновляем статистику
                document.getElementById('stats-levels').textContent = this.state.maxLevel - 1;
                document.getElementById('stats-coins').textContent = this.state.coins;
                
                // Обновляем настройки
                document.getElementById('toggle-sound').classList.toggle('active', this.state.settings.sound);
                document.getElementById('toggle-vibration').classList.toggle('active', this.state.settings.vibration);
                
                // Обновляем языки
                document.querySelectorAll('.lang-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                document.getElementById(`lang-${this.state.settings.language}`).classList.add('active');
            },
            
            // Показать экран
            showScreen(screenId) {
                // Скрыть все экраны
                document.querySelectorAll('.screen').forEach(screen => {
                    screen.classList.remove('active');
                });
                
                // Показать нужный экран
                document.getElementById(`scr-${screenId}`).classList.add('active');
                
                // Обновить навигацию
                document.querySelectorAll('.nav-item').forEach(item => {
                    item.classList.remove('active');
                });
                document.getElementById(`nav-${screenId}`).classList.add('active');
                
                // Показать/скрыть кнопку назад
                document.getElementById('btn-back').style.display = 
                    (screenId === 'game') ? 'block' : 'none';
                
                // Обновить заголовок
                document.getElementById('header').style.visibility = 
                    (screenId === 'home' || screenId === 'game') ? 'visible' : 'hidden';
                
                // Остановить конфетти если не на экране победы
                if (screenId !== 'win') {
                    this.stopConfetti();
                }
            },
            
            // Начать уровень
            async startLevel(level = this.state.currentLevel) {
                if (this.state.hearts <= 0) {
                    this.showHeartsModal();
                    return;
                }
                
                this.state.currentLevel = level;
                this.showScreen('game');
                
                // Даем время на отрисовку экрана
                setTimeout(() => {
                    this.loadLevel(level);
                }, 50);
            },
            
            // Загрузка уровня
            loadLevel(level) {
                console.log(`Loading level ${level}`);
                this.showDebugInfo(`Loading level ${level}`);
                
                const board = document.getElementById('board');
                if (!board) return;
                
                // Очищаем доску
                board.innerHTML = '';
                
                // Определяем размер доски
                this.boardSize = this.getBoardSize(level);
                
                // Устанавливаем размер доски
                const container = document.querySelector('.board-container');
                const size = Math.min(container.offsetWidth, container.offsetHeight) - 40;
                board.style.width = `${size}px`;
                board.style.height = `${size}px`;
                
                // Добавляем сетку
                this.addGrid(board, size);
                
                // Генерируем или загружаем уровень
                let levelData;
                if (this.state.levels[level] && !this.isTelegram()) {
                    levelData = this.state.levels[level];
                } else {
                    levelData = this.generateLevel(level, this.boardSize);
                    this.state.levels[level] = levelData;
                }
                
                // Сохраняем текущий уровень
                this.currentBoard = levelData;
                
                // Создаем стрелки
                this.createArrows(board, size, levelData);
                
                // Обновляем UI
                this.updateUI();
                
                // Сохраняем состояние
                this.saveGameState();
            },
            
            // Создание стрелок
            createArrows(board, boardSize, levelData) {
                const cellSize = boardSize / this.boardSize;
                const arrowSize = Math.min(cellSize * 0.8, 50);
                
                console.log(`Creating ${levelData.arrows.length} arrows`);
                this.showDebugInfo(`Creating ${levelData.arrows.length} arrows`);
                
                levelData.arrows.forEach((arrow, index) => {
                    if (arrow.solved) return;
                    
                    const arrowElement = document.createElement('div');
                    arrowElement.className = `arrow ${arrow.direction}`;
                    arrowElement.style.width = `${arrowSize}px`;
                    arrowElement.style.height = `${arrowSize}px`;
                    arrowElement.style.left = `${arrow.x * cellSize + (cellSize - arrowSize) / 2}px`;
                    arrowElement.style.top = `${arrow.y * cellSize + (cellSize - arrowSize) / 2}px`;
                    
                    // Внутренний контейнер
                    const inner = document.createElement('div');
                    inner.className = 'arrow-inner';
                    
                    // Линия стрелки
                    const line = document.createElement('div');
                    line.className = 'arrow-line';
                    
                    // Голова стрелки
                    const head = document.createElement('div');
                    head.className = 'arrow-head';
                    
                    inner.appendChild(line);
                    inner.appendChild(head);
                    arrowElement.appendChild(inner);
                    
                    // Сохраняем ссылку
                    arrow.element = arrowElement;
                    
                    // Обработчик клика
                    arrowElement.addEventListener('click', (e) => {
                        e.stopPropagation();
                        this.handleArrowClick(arrow);
                    });
                    
                    // Для тач-устройств
                    arrowElement.addEventListener('touchstart', (e) => {
                        e.stopPropagation();
                        e.preventDefault();
                        this.handleArrowClick(arrow);
                    });
                    
                    board.appendChild(arrowElement);
                });
                
                // Принудительная перерисовка
                setTimeout(() => {
                    const arrows = board.querySelectorAll('.arrow');
                    console.log(`Arrows rendered: ${arrows.length}`);
                    this.showDebugInfo(`Arrows rendered: ${arrows.length}`);
                    
                    if (arrows.length === 0) {
                        this.showDebugInfo('No arrows! Regenerating...');
                        this.regenerateLevel(levelData.level);
                    }
                }, 100);
            },
            
            // Обработка клика по стрелке
            handleArrowClick(arrow) {
                if (arrow.solved) return;
                
                // Проверяем столкновения
                const collision = this.checkCollision(arrow, this.currentBoard.arrows);
                
                if (collision) {
                    // Столкновение
                    this.showError(arrow);
                    this.loseHeart();
                } else {
                    // Успех
                    this.solveArrow(arrow);
                    
                    // Проверяем завершение уровня
                    const allSolved = this.currentBoard.arrows.every(a => a.solved);
                    if (allSolved) {
                        this.completeLevel();
                    }
                }
            },
            
            // Показать ошибку
            showError(arrow) {
                // Визуальный эффект
                if (arrow.element) {
                    arrow.element.classList.add('error');
                    arrow.element.classList.add('shake');
                    
                    setTimeout(() => {
                        if (arrow.element) {
                            arrow.element.classList.remove('error');
                            arrow.element.classList.remove('shake');
                        }
                    }, 500);
                }
                
                // Звук и вибрация
                if (this.state.settings.sound) this.playErrorSound();
                if (this.state.settings.vibration) this.vibrate('error');
            },
            
            // Решить стрелку
            solveArrow(arrow) {
                arrow.solved = true;
                
                // Анимация исчезновения
                if (arrow.element) {
                    arrow.element.style.opacity = '0';
                    setTimeout(() => {
                        if (arrow.element && arrow.element.parentNode) {
                            arrow.element.parentNode.removeChild(arrow.element);
                        }
                    }, 300);
                }
                
                // Звук успеха
                if (this.state.settings.sound) this.playSuccessSound();
                if (this.state.settings.vibration) this.vibrate('success');
            },
            
            // Завершить уровень
            completeLevel() {
                console.log('Level completed!');
                
                // Награда
                this.state.coins += CONFIG.COINS_PER_LEVEL;
                
                // Обновляем максимальный уровень
                if (this.state.currentLevel >= this.state.maxLevel) {
                    this.state.maxLevel = this.state.currentLevel + 1;
                }
                
                // Сохраняем
                this.saveGameState();
                
                // Обновляем Telegram если подключен
                if (this.state.telegram.connected) {
                    this.updateTelegramScore();
                }
                
                // Показываем экран победы
                this.showVictoryScreen();
            },
            
            // Показать экран победы
            showVictoryScreen() {
                this.showScreen('win');
                document.getElementById('coins-earned-amount').textContent = CONFIG.COINS_PER_LEVEL;
                
                // Запускаем конфетти
                setTimeout(() => {
                    this.startConfetti();
                    if (this.state.settings.sound) this.playVictorySound();
                    if (this.state.settings.vibration) this.vibrate('victory');
                }, 300);
            },
            
            // Следующий уровень
            nextLevel() {
                this.state.currentLevel++;
                this.startLevel(this.state.currentLevel);
            },
            
            // Генерация уровня
            generateLevel(level, boardSize) {
                console.log(`Generating level ${level}, board size: ${boardSize}`);
                
                const arrows = [];
                const directions = ['right', 'left', 'up', 'down'];
                
                // Количество стрелок зависит от уровня
                const arrowCount = Math.min(6 + Math.floor(level / 3), boardSize * boardSize - 1);
                
                // Генератор случайных чисел
                let seed = level * 12345;
                const random = () => {
                    seed = (seed * 16807) % 2147483647;
                    return seed / 2147483647;
                };
                
                // Создаем стрелки
                for (let i = 0; i < arrowCount; i++) {
                    let x, y, direction;
                    let valid = false;
                    let attempts = 0;
                    
                    // Пытаемся найти валидную позицию
                    while (!valid && attempts < 100) {
                        x = Math.floor(random() * boardSize);
                        y = Math.floor(random() * boardSize);
                        direction = directions[Math.floor(random() * 4)];
                        
                        // Проверяем, не выходит ли стрелка за пределы
                        valid = true;
                        if (direction === 'right' && x === boardSize - 1) valid = false;
                        if (direction === 'left' && x === 0) valid = false;
                        if (direction === 'up' && y === 0) valid = false;
                        if (direction === 'down' && y === boardSize - 1) valid = false;
                        
                        // Проверяем, нет ли уже стрелки в этой клетке
                        if (valid) {
                            for (const arrow of arrows) {
                                if (arrow.x === x && arrow.y === y) {
                                    valid = false;
                                    break;
                                }
                            }
                        }
                        
                        attempts++;
                    }
                    
                    if (valid) {
                        arrows.push({
                            id: i,
                            x: x,
                            y: y,
                            direction: direction,
                            solved: false
                        });
                    }
                }
                
                return {
                    level: level,
                    boardSize: boardSize,
                    arrows: arrows
                };
            },
            
            // Регенерация уровня (при проблемах)
            regenerateLevel(level) {
                console.log(`Regenerating level ${level}`);
                delete this.state.levels[level];
                this.loadLevel(level);
            },
            
            // Проверка столкновений
            checkCollision(clickedArrow, allArrows) {
                for (const arrow of allArrows) {
                    if (arrow.id === clickedArrow.id || arrow.solved) continue;
                    
                    // Проверяем столкновение по осям
                    if (clickedArrow.direction === 'right' && 
                        arrow.y === clickedArrow.y && 
                        arrow.x > clickedArrow.x) {
                        return true;
                    }
                    
                    if (clickedArrow.direction === 'left' && 
                        arrow.y === clickedArrow.y && 
                        arrow.x < clickedArrow.x) {
                        return true;
                    }
                    
                    if (clickedArrow.direction === 'down' && 
                        arrow.x === clickedArrow.x && 
                        arrow.y > clickedArrow.y) {
                        return true;
                    }
                    
                    if (clickedArrow.direction === 'up' && 
                        arrow.x === clickedArrow.x && 
                        arrow.y < clickedArrow.y) {
                        return true;
                    }
                }
                
                return false;
            },
            
            // Добавить сетку
            addGrid(board, size) {
                const cellSize = size / this.boardSize;
                
                // Вертикальные линии
                for (let i = 1; i < this.boardSize; i++) {
                    const line = document.createElement('div');
                    line.className = 'grid-line';
                    line.style.left = `${i * cellSize}px`;
                    line.style.top = '0';
                    line.style.width = '1px';
                    line.style.height = '100%';
                    board.appendChild(line);
                }
                
                // Горизонтальные линии
                for (let i = 1; i < this.boardSize; i++) {
                    const line = document.createElement('div');
                    line.className = 'grid-line';
                    line.style.left = '0';
                    line.style.top = `${i * cellSize}px`;
                    line.style.width = '100%';
                    line.style.height = '1px';
                    board.appendChild(line);
                }
            },
            
            // Получить размер доски
            getBoardSize(level) {
                if (level <= 10) return 5;
                if (level <= 20) return 6;
                if (level <= 30) return 7;
                if (level <= 40) return 8;
                return 9;
            },
            
            // Потеря сердца
            loseHeart() {
                if (this.state.hearts > 0) {
                    this.state.hearts--;
                    
                    // Добавляем таймер восстановления
                    if (this.state.hearts < CONFIG.DEFAULT_HEARTS) {
                        const recoveryTime = Date.now() + CONFIG.HEART_RECOVERY_TIME;
                        this.state.heartTimers.push(recoveryTime);
                    }
                    
                    this.updateUI();
                    this.saveGameState();
                    
                    // Если сердца закончились
                    if (this.state.hearts <= 0) {
                        setTimeout(() => {
                            this.showScreen('home');
                        }, 1000);
                    }
                }
            },
            
            // Таймеры
            startTimers() {
                if (this.gameTimer) clearInterval(this.gameTimer);
                
                this.gameTimer = setInterval(() => {
                    this.checkHeartRecovery();
                }, 1000);
            },
            
            // Проверка восстановления сердец
            checkHeartRecovery() {
                const now = Date.now();
                let updated = false;
                
                // Убираем прошедшие таймеры и восстанавливаем сердца
                this.state.heartTimers = this.state.heartTimers.filter(timer => {
                    if (now >= timer) {
                        if (this.state.hearts < CONFIG.DEFAULT_HEARTS) {
                            this.state.hearts++;
                            updated = true;
                        }
                        return false; // Удаляем таймер
                    }
                    return true; // Сохраняем таймер
                });
                
                if (updated) {
                    this.updateUI();
                    this.saveGameState();
                }
                
                // Обновляем модальное окно если открыто
                if (document.getElementById('modal-timers').style.display === 'flex') {
                    this.updateHeartsModal();
                }
            },
            
            // Показать модальное окно сердец
            showHeartsModal() {
                const modal = document.getElementById('modal-timers');
                modal.style.display = 'flex';
                this.updateHeartsModal();
            },
            
            // Обновить модальное окно сердец
            updateHeartsModal() {
                const list = document.getElementById('timers-list');
                if (!list) return;
                
                list.innerHTML = '';
                
                if (this.state.heartTimers.length === 0) {
                    list.innerHTML = '<div style="padding: 10px; color: #666;">All hearts restored!</div>';
                    return;
                }
                
                this.state.heartTimers.forEach((timer, index) => {
                    const timeLeft = Math.max(0, timer - Date.now());
                    const minutes = Math.floor(timeLeft / 60000);
                    const seconds = Math.floor((timeLeft % 60000) / 1000);
                    
                    const item = document.createElement('div');
                    item.className = 'timer-item';
                    item.innerHTML = `
                        <span>Heart ${index + 1}</span>
                        <span>${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}</span>
                    `;
                    list.appendChild(item);
                });
            },
            
            // Скрыть модальное окно
            hideModal() {
                document.getElementById('modal-timers').style.display = 'none';
            },
            
            // Подключение Telegram (демо)
            connectTelegram() {
                // Демо-режим
                this.state.telegram.connected = true;
                this.state.telegram.userId = Math.floor(Math.random() * 1000000);
                this.state.telegram.username = `DemoUser${this.state.telegram.userId}`;
                this.state.coins = 100;
                this.state.maxLevel = 5;
                
                // Обновляем интерфейс
                document.getElementById('telegram-info').style.display = 'block';
                document.getElementById('nickname').textContent = this.state.telegram.username;
                document.getElementById('tg-status-text').textContent = `ID: ${this.state.telegram.userId} (Demo)`;
                document.getElementById('connect-btn').style.display = 'none';
                
                this.updateUI();
                this.saveGameState();
                
                alert('Connected to Telegram (demo mode)!');
            },
            
            // Обновление счета в Telegram
            async updateTelegramScore() {
                if (!this.state.telegram.connected || !this.state.telegram.userId) return;
                
                try {
                    await fetch(`${CONFIG.API_URL}/update_score`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            user_id: this.state.telegram.userId,
                            username: this.state.telegram.username,
                            level: this.state.maxLevel,
                            coins_earned: CONFIG.COINS_PER_LEVEL
                        })
                    });
                } catch (error) {
                    console.error('Error updating Telegram score:', error);
                }
            },
            
            // Переключение настроек
            toggleSetting(setting) {
                if (this.state.settings[setting] !== undefined) {
                    this.state.settings[setting] = !this.state.settings[setting];
                    this.updateUI();
                    this.saveGameState();
                }
            },
            
            // Установка языка
            setLanguage(lang) {
                this.state.settings.language = lang;
                this.updateUI();
                this.saveGameState();
            },
            
            // Проверка, в Telegram ли мы
            isTelegram() {
                return !!(window.Telegram && Telegram.WebApp);
            },
            
            // Сброс прогресса
            async resetProgress() {
                if (confirm('Are you sure you want to reset all progress? This cannot be undone.')) {
                    this.resetGameState();
                    
                    // Очищаем хранилища
                    if (window.Telegram?.WebApp?.CloudStorage) {
                        await Telegram.WebApp.CloudStorage.removeItem('game_state');
                    }
                    
                    if (localStorage) {
                        localStorage.removeItem(CONFIG.STORAGE_KEY);
                    }
                    
                    this.updateUI();
                    this.showScreen('home');
                    alert('Progress has been reset!');
                }
            },
            
            // Звуки
            playSuccessSound() {
                // Простой звук через Web Audio API
                try {
                    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    
                    oscillator.frequency.value = 800;
                    oscillator.type = 'sine';
                    
                    gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
                    
                    oscillator.start();
                    oscillator.stop(audioContext.currentTime + 0.3);
                } catch (e) {
                    console.log('Audio not supported');
                }
            },
            
            playErrorSound() {
                try {
                    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    
                    oscillator.frequency.value = 300;
                    oscillator.type = 'sawtooth';
                    
                    gainNode.gain.setValueAtTime(0.5, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
                    
                    oscillator.start();
                    oscillator.stop(audioContext.currentTime + 0.2);
                } catch (e) {
                    console.log('Audio not supported');
                }
            },
            
            playVictorySound() {
                try {
                    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    
                    // Проигрываем несколько нот
                    for (let i = 0; i < 4; i++) {
                        setTimeout(() => {
                            const oscillator = audioContext.createOscillator();
                            const gainNode = audioContext.createGain();
                            
                            oscillator.connect(gainNode);
                            gainNode.connect(audioContext.destination);
                            
                            oscillator.frequency.value = 523.25 * (i + 1);
                            oscillator.type = 'triangle';
                            
                            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
                            
                            oscillator.start();
                            oscillator.stop(audioContext.currentTime + 0.2);
                        }, i * 100);
                    }
                } catch (e) {
                    console.log('Audio not supported');
                }
            },
            
            // Вибрация
            vibrate(type) {
                if (!navigator.vibrate) return;
                
                if (type === 'success') {
                    navigator.vibrate(50);
                } else if (type === 'error') {
                    navigator.vibrate([50, 30, 50]);
                } else if (type === 'victory') {
                    navigator.vibrate([100, 50, 100, 50, 200]);
                }
            },
            
            // Конфетти
            initConfetti() {
                this.confettiCanvas = document.getElementById('confetti-canvas');
                if (!this.confettiCanvas) return;
                
                this.confettiCtx = this.confettiCanvas.getContext('2d');
                this.confettiParticles = [];
            },
            
            startConfetti() {
                if (!this.confettiCanvas || !this.confettiCtx) return;
                
                // Устанавливаем размер
                this.confettiCanvas.width = this.confettiCanvas.offsetWidth;
                this.confettiCanvas.height = this.confettiCanvas.offsetHeight;
                
                // Создаем частицы
                this.confettiParticles = [];
                const colors = ['#ff4d4d', '#2ecc71', '#3498db', '#f1c40f', '#9b59b6'];
                
                for (let i = 0; i < 100; i++) {
                    this.confettiParticles.push({
                        x: Math.random() * this.confettiCanvas.width,
                        y: Math.random() * this.confettiCanvas.height - this.confettiCanvas.height,
                        size: Math.random() * 10 + 5,
                        speed: Math.random() * 3 + 2,
                        color: colors[Math.floor(Math.random() * colors.length)],
                        rotation: Math.random() * 360,
                        rotationSpeed: (Math.random() - 0.5) * 10
                    });
                }
                
                // Анимация
                this.animateConfetti();
            },
            
            animateConfetti() {
                if (!this.confettiCanvas || !this.confettiCtx || this.confettiParticles.length === 0) return;
                
                // Очищаем канвас
                this.confettiCtx.clearRect(0, 0, this.confettiCanvas.width, this.confettiCanvas.height);
                
                // Обновляем и рисуем частицы
                for (let i = this.confettiParticles.length - 1; i >= 0; i--) {
                    const p = this.confettiParticles[i];
                    
                    // Обновляем позицию
                    p.y += p.speed;
                    p.x += Math.sin(p.y * 0.01);
                    p.rotation += p.rotationSpeed;
                    
                    // Рисуем
                    this.confettiCtx.save();
                    this.confettiCtx.translate(p.x, p.y);
                    this.confettiCtx.rotate(p.rotation * Math.PI / 180);
                    this.confettiCtx.fillStyle = p.color;
                    this.confettiCtx.fillRect(-p.size/2, -p.size/2, p.size, p.size);
                    this.confettiCtx.restore();
                    
                    // Удаляем если вышла за пределы
                    if (p.y > this.confettiCanvas.height + 50) {
                        this.confettiParticles.splice(i, 1);
                    }
                }
                
                // Продолжаем анимацию если есть частицы
                if (this.confettiParticles.length > 0) {
                    requestAnimationFrame(() => this.animateConfetti());
                }
            },
            
            stopConfetti() {
                this.confettiParticles = [];
                if (this.confettiCtx && this.confettiCanvas) {
                    this.confettiCtx.clearRect(0, 0, this.confettiCanvas.width, this.confettiCanvas.height);
                }
            },
            
            // Отладочная информация
            showDebugInfo(message) {
                const debug = document.getElementById('debug-info');
                if (debug) {
                    debug.textContent = message;
                    debug.style.display = 'block';
                    
                    // Автоскрытие через 3 секунды
                    setTimeout(() => {
                        debug.style.display = 'none';
                    }, 3000);
                }
            }
        };

        // Инициализация при загрузке
        window.addEventListener('load', () => {
            console.log('Window loaded, initializing game...');
            Game.init();
            
            // Для Telegram: принудительная инициализация
            if (window.Telegram?.WebApp) {
                Telegram.WebApp.ready();
                Telegram.WebApp.expand();
                
                // Перехват событий видимости
                document.addEventListener('visibilitychange', () => {
                    if (document.visibilityState === 'visible') {
                        console.log('App became visible, refreshing...');
                        setTimeout(() => {
                            Game.updateUI();
                        }, 100);
                    }
                });
            }
        });

        // Обработка ошибок
        window.addEventListener('error', (error) => {
            console.error('Global error:', error);
            Game.showDebugInfo(`Error: ${error.message}`);
        });
    </script>
</body>
</html>
